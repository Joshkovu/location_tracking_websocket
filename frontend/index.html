<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Delivery Tracking</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        #map {
            flex: 1;
            height: 100vh;
        }

        .sidebar {
            width: 380px;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .delivery-id {
            font-size: 14px;
            opacity: 0.9;
        }

        .status-card {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .status-pending {
            background: #ffeaa7;
            color: #d63031;
        }

        .status-assigned {
            background: #74b9ff;
            color: #0984e3;
        }

        .status-picked_up {
            background: #a29bfe;
            color: #6c5ce7;
        }

        .status-in_transit {
            background: #55efc4;
            color: #00b894;
        }

        .status-nearby {
            background: #fd79a8;
            color: #e84393;
        }

        .status-arriving {
            background: #fdcb6e;
            color: #e17055;
        }

        .status-delivered {
            background: #00b894;
            color: white;
        }

        .eta-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .eta-time {
            font-size: 32px;
            font-weight: bold;
            color: #2d3436;
            margin: 10px 0;
        }

        .eta-label {
            color: #636e72;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .eta-details {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .eta-detail {
            flex: 1;
        }

        .eta-detail-value {
            font-size: 20px;
            font-weight: bold;
            color: #2d3436;
        }

        .eta-detail-label {
            font-size: 12px;
            color: #636e72;
            margin-top: 2px;
        }

        .driver-info {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .driver-info h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #2d3436;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .info-label {
            color: #636e72;
        }

        .info-value {
            color: #2d3436;
            font-weight: 500;
        }

        .location-updates {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .location-updates h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #2d3436;
        }

        .update-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 13px;
            border-left: 3px solid #667eea;
        }

        .update-item.alert {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .update-item.success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .update-time {
            color: #636e72;
            font-size: 11px;
            margin-top: 5px;
        }
      .new{
       font-size: 14px; color: #636e72; margin-top: 5px;
      }
        .connection-status {
            padding: 10px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #95a5a6;
        }

        .status-dot.connected {
            background: #00b894;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .driver-marker-icon {
            background: #667eea;
            border: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .accuracy-circle {
            fill: rgba(102, 126, 234, 0.1);
            stroke: rgba(102, 126, 234, 0.3);
            stroke-width: 2;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 50vh;
            }

            #map {
                height: 50vh;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="map"></div>
        <div class="sidebar">
            <div class="header">
                <h1>Delivery Tracking</h1>
                <div class="delivery-id">Delivery #<span id="deliveryId">Loading...</span></div>
            </div>

            <div class="status-card">
                <span id="statusBadge" class="status-badge">Loading...</span>
                <div id="statusMessage" class="new">
                    Connecting to tracking service...
                </div>
            </div>

            <div class="eta-section">
                <div class="eta-label">Estimated Arrival</div>
                <div class="eta-time" id="etaTime">--:--</div>
                <div class="eta-details">
                    <div class="eta-detail">
                        <div class="eta-detail-value" id="etaDistance">--</div>
                        <div class="eta-detail-label">km away</div>
                    </div>
                    <div class="eta-detail">
                        <div class="eta-detail-value" id="etaDuration">--</div>
                        <div class="eta-detail-label">minutes</div>
                    </div>
                </div>
            </div>

            <div class="driver-info">
                <h3>Driver Information</h3>
                <div class="info-row">
                    <span class="info-label">Driver ID</span>
                    <span class="info-value" id="driverIdInfo">--</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Current Speed</span>
                    <span class="info-value" id="driverSpeed">-- km/h</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Last Update</span>
                    <span class="info-value" id="lastUpdate">--</span>
                </div>
            </div>

            <div class="location-updates">
                <h3>Live Updates</h3>
                <div id="updatesList"></div>
            </div>

            <div class="connection-status">
                <div id="statusDot" class="status-dot"></div>
                <span id="connectionStatus">Connecting...</span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        class DeliveryTracker {
            constructor() {
                this.ws = null;
                this.map = null;
                this.driverMarker = null;
                this.destinationMarker = null;
                this.routeLine = null;
                this.accuracyCircle = null;
                this.updates = [];
                this.maxUpdates = 20;

                // Get params from URL
                const urlParams = new URLSearchParams(window.location.search);
                this.userId = urlParams.get('user_id') || 'customer123';
                this.deliveryId = urlParams.get('delivery_id') || 'DEL001';

                this.initMap();
                this.connect();
            }

            initMap() {
                // Initialize Leaflet map centered on Uganda
                // Kampala coordinates: 0.3476Â°N, 32.5825Â°E
                this.map = L.map('map').setView([0.3476, 32.5825], 13);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors',
                    maxZoom: 19,
                    minZoom: 6
                }).addTo(this.map);

                
                const ugandaBounds = L.latLngBounds(
                    L.latLng(-1.4823, 29.5732),  
                    L.latLng(4.2340, 35.0000)     
                );

                
                L.rectangle(ugandaBounds, {
                    color: "#667eea",
                    weight: 2,
                    fillOpacity: 0,
                    dashArray: '5, 5'
                }).addTo(this.map);

                
                const ugandaCities = [
                    { name: "Kampala", lat: 0.3476, lon: 32.5825 },
                    { name: "Entebbe", lat: 0.0564, lon: 32.4795 },
                    { name: "Jinja", lat: 0.4244, lon: 33.2040 },
                    { name: "Mbarara", lat: -0.6069, lon: 30.6582 },
                    { name: "Gulu", lat: 2.7746, lon: 32.2990 }
                ];

                ugandaCities.forEach(city => {
                    L.circleMarker([city.lat, city.lon], {
                        radius: 3,
                        color: '#95a5a6',
                        fillColor: '#95a5a6',
                        fillOpacity: 0.5
                    }).addTo(this.map).bindTooltip(city.name, { permanent: false, direction: 'top' });
                });

                
                const driverIcon = L.divIcon({
                    html: '<div class="driver-marker-icon">ðŸš—</div>',
                    className: 'custom-marker',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });

                this.driverMarker = L.marker([0, 0], {
                    icon: driverIcon,
                    opacity: 0
                }).addTo(this.map);

                // Destination marker
                this.destinationMarker = L.marker([0, 0], {
                    opacity: 0
                }).addTo(this.map);

                // Route line
                this.routeLine = L.polyline([], {
                    color: '#667eea',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(this.map);
            }

            connect() {
                const wsUrl = `ws://localhost:8080/ws?user_id=${this.userId}&user_type=customer&delivery_id=${this.deliveryId}`;

                this.ws = new WebSocket(wsUrl);

                this.ws.onopen = () => {
                    console.log('WebSocket connected');
                    this.updateConnectionStatus(true);
                    this.addUpdate('Connected to tracking service', 'success');
                };

                this.ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    this.handleMessage(message);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.addUpdate('Connection error occurred', 'alert');
                };

                this.ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    this.updateConnectionStatus(false);
                    this.addUpdate('Disconnected. Reconnecting...', 'alert');

                    // Attempt reconnection after 5 seconds
                    setTimeout(() => this.connect(), 5000);
                };
            }

            handleMessage(message) {
                console.log('Received message:', message);

                switch (message.type) {
                    case 'location_update':
                        this.handleLocationUpdate(message.data);
                        break;
                    case 'eta_update':
                        this.handleETAUpdate(message.data);
                        break;
                    case 'proximity_alert':
                        this.handleProximityAlert(message.data);
                        break;
                    case 'status_change':
                        this.handleStatusChange(message.data);
                        break;
                    case 'delivery_completed':
                        this.handleDeliveryCompleted(message.data);
                        break;
                }
            }

            handleLocationUpdate(data) {
                const loc = data.location;

                // Update driver marker position
                this.driverMarker.setLatLng([loc.lat, loc.lon]);
                this.driverMarker.setOpacity(1);

                // Update accuracy circle
                if (this.accuracyCircle) {
                    this.map.removeLayer(this.accuracyCircle);
                }
                if (loc.accuracy) {
                    this.accuracyCircle = L.circle([loc.lat, loc.lon], {
                        radius: loc.accuracy,
                        className: 'accuracy-circle',
                        fillOpacity: 0.1,
                        color: '#667eea',
                        weight: 2
                    }).addTo(this.map);
                }

                // Update driver info
                document.getElementById('driverIdInfo').textContent = data.driver_id;
                document.getElementById('driverSpeed').textContent =
                    loc.speed ? `${loc.speed.toFixed(1)} km/h` : '-- km/h';
                document.getElementById('lastUpdate').textContent =
                    new Date(loc.timestamp).toLocaleTimeString();

                // Center map on first update
                if (this.updates.length === 0) {
                    this.map.setView([loc.lat, loc.lon], 15);
                }

                this.addUpdate(`Driver location updated (${loc.lat.toFixed(5)}, ${loc.lon.toFixed(5)})`);
            }

            handleETAUpdate(data) {
                const arrival = new Date(data.estimated_arrival);
                const now = new Date();

                // Format ETA time
                document.getElementById('etaTime').textContent =
                    arrival.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                document.getElementById('etaDistance').textContent =
                    data.distance_km.toFixed(1);

                document.getElementById('etaDuration').textContent =
                    data.duration_minutes;

                this.addUpdate(`ETA updated: ${data.duration_minutes} minutes`);
            }

            handleProximityAlert(data) {
                let alertClass = 'alert';
                if (data.alert_level === 'arrived') {
                    alertClass = 'success';
                }

                this.addUpdate(data.message, alertClass);

                // Show notification if supported
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Delivery Update', {
                        body: data.message,
                        icon: 'ðŸš—'
                    });
                }
            }

            handleStatusChange(data) {
                // Update status badge
                const statusBadge = document.getElementById('statusBadge');
                statusBadge.textContent = data.new_status.replace('_', ' ');
                statusBadge.className = `status-badge status-${data.new_status}`;

                document.getElementById('statusMessage').textContent = data.message;

                this.addUpdate(`Status changed: ${data.message}`, 'success');
            }

            handleDeliveryCompleted(data) {
                this.addUpdate('ðŸŽ‰ Delivery completed!', 'success');

                // Update UI to show completion
                document.getElementById('statusMessage').textContent =
                    'Your delivery has been completed. Thank you!';
            }

            updateConnectionStatus(connected) {
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('connectionStatus');

                if (connected) {
                    statusDot.classList.add('connected');
                    statusText.textContent = 'Connected';
                } else {
                    statusDot.classList.remove('connected');
                    statusText.textContent = 'Disconnected';
                }
            }

            addUpdate(message, type = 'default') {
                const updateItem = document.createElement('div');
                updateItem.className = `update-item ${type}`;

                const messageDiv = document.createElement('div');
                messageDiv.textContent = message;

                const timeDiv = document.createElement('div');
                timeDiv.className = 'update-time';
                timeDiv.textContent = new Date().toLocaleTimeString();

                updateItem.appendChild(messageDiv);
                updateItem.appendChild(timeDiv);

                const updatesList = document.getElementById('updatesList');
                updatesList.insertBefore(updateItem, updatesList.firstChild);

                // Keep only last N updates
                this.updates.unshift(message);
                if (this.updates.length > this.maxUpdates) {
                    this.updates.pop();
                    updatesList.removeChild(updatesList.lastChild);
                }
            }

            setDestination(lat, lon) {
                this.destinationMarker.setLatLng([lat, lon]);
                this.destinationMarker.setOpacity(1);
                this.destinationMarker.bindPopup('Delivery Destination').openPopup();
            }

            updateRoute(driverLat, driverLon, destLat, destLon) {
                this.routeLine.setLatLngs([
                    [driverLat, driverLon],
                    [destLat, destLon]
                ]);
            }
        }
        
        // Initialize tracker when page loads
        let tracker;
        window.addEventListener('DOMContentLoaded', () => {
            tracker = new DeliveryTracker();

            // Set delivery ID in header
            const urlParams = new URLSearchParams(window.location.search);
            document.getElementById('deliveryId').textContent =
                urlParams.get('delivery_id') || 'DEL001';

            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }

            // Example: Set a destination (you would get this from your backend)
            // tracker.setDestination(0.3476, 32.5825); // Kampala
        });
    </script>
</body>

</html>